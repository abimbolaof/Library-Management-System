using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using MySql.Data;
using MySql.Data.MySqlClient;
using System.IO;

namespace LIBRARY
{
    public partial class Report : Form
    {
        public Report()
        {
            InitializeComponent();
        }

        private void Report_Load(object sender, EventArgs e)
        {
            fromDate.Text = "01" + "/" + DateTime.Now.AddMonths(-1).Month.ToString() + "/" + DateTime.Now.Year.ToString();
            toDate.Text = "01" + "/" + DateTime.Now.Month.ToString() + "/" + DateTime.Now.Year.ToString();
        }

        private void toolStripButton1_Click(object sender, EventArgs e)
        {
            toolStripButton1.Enabled = false;
            browser.ShowPrintDialog();
            toolStripButton1.Enabled = true;
        }


        string[][] ParseDates(string st, string en)
        {
            string[][] result = new string[2][];
            result[0] = new string[3];
            result[1] = new string[3];

            string[] strt = new string[4];
            string[] end = new string[4];

            char[] sep = new char[2];
            sep[0] = '/';

            strt = st.Split(sep);
            end = en.Split(sep);

            result[0] = strt;
            result[1] = end;

            return result;
        }


        private void toolStripButton2_Click(object sender, EventArgs e)
        {
            try
            {
                //count total number of books
                string statement = "", day = "", month = "", year = "";
                string[] reportStr = new string[50];

                int noOfBooks = 0, noOfSerials = 0, noOfStudents = 0, noOfStaff = 0, noOfLoaned = 0,
                       noOfReturned = 0, noOfOverdue = 0, noOfSubjects = 0;

                string HEADER = "ACU LIBRARY MANAGEMENT INFORMATION SYSTEM";
                string TITLE = "          GENERAL SYSTEM REPORT\n\n";


                //extract userid from connection string
                char[] sep = new char[2];
                sep[0] = '=';
                sep[1] = ';';
                string[] str = new string[10];

                str = ConnectionString.Split(sep);

                string[][] dates = ParseDates(fromDate.Text, toDate.Text);

                day = dates[0][0];
                month = dates[0][1];
                year = dates[0][2];
                startDate = day + "/" + month + "/" + year;

                day = dates[1][0];
                month = dates[1][1];
                year = dates[1][2];
                endDate = day + "/" + month + "/" + year;

                //check if dates are of valid formats
                DateTime.Parse(startDate);
                DateTime.Parse(endDate);



                string info = "DATE : " + DateTime.Now.ToLongDateString() + "\nTIME : " + DateTime.Now.ToShortTimeString() +
                              "\nReport Generated By : " + str[5] + "\n\n\n\n";

                try
                {
                    MySqlConnection con = new MySqlConnection(ConnectionString);
                    con.Open();

                    statement = "SELECT COUNT(*) FROM books;";

                    MySqlCommand com = new MySqlCommand(statement, con);
                    MySqlDataReader reader = com.ExecuteReader();


                    reader.Read();
                    noOfBooks = int.Parse(reader.GetValue(0).ToString());
                    reader.Close();

                    //count no of serials
                    statement = "SELECT COUNT(*) FROM serials_record;";
                    com.CommandText = statement;
                    reader = com.ExecuteReader();
                    reader.Read();
                    noOfSerials = int.Parse(reader.GetValue(0).ToString());
                    reader.Close();


                    //count no of registered student patrons
                    statement = "SELECT COUNT(*) FROM registration WHERE type='student';";
                    com.CommandText = statement;
                    reader = com.ExecuteReader();
                    reader.Read();
                    noOfStudents = int.Parse(reader.GetValue(0).ToString());
                    reader.Close();


                    //count no of registered staff patrons
                    statement = "SELECT COUNT(*) FROM registration WHERE type='staff';";
                    com.CommandText = statement;
                    reader = com.ExecuteReader();
                    reader.Read();
                    noOfStaff = int.Parse(reader.GetValue(0).ToString());
                    reader.Close();


                    //count no of loaned items
                    statement = "SELECT COUNT(*) FROM loaned WHERE borrowdate >='" + startDate + "' AND borrowdate <='" + endDate + "';";
                    com.CommandText = statement;
                    reader = com.ExecuteReader();
                    reader.Read();
                    noOfLoaned = int.Parse(reader.GetValue(0).ToString());
                    reader.Close();


                    //count no of returned items
                    statement = "SELECT COUNT(*) FROM returned WHERE returndate >='" + startDate + "' AND returndate <='" + endDate + "';";
                    com.CommandText = statement;
                    reader = com.ExecuteReader();
                    reader.Read();
                    noOfReturned = int.Parse(reader.GetValue(0).ToString());
                    reader.Close();


                    //count no of overdue items
                    statement = "SELECT COUNT(*) FROM overdue;";
                    com.CommandText = statement;
                    reader = com.ExecuteReader();
                    reader.Read();
                    noOfOverdue = int.Parse(reader.GetValue(0).ToString());
                    reader.Close();


                    //count no of subjects
                    statement = "SELECT COUNT(*) FROM subject;";
                    com.CommandText = statement;
                    reader = com.ExecuteReader();
                    reader.Read();
                    noOfSubjects = int.Parse(reader.GetValue(0).ToString());
                    reader.Close();

                    con.Close();
                }
                catch (Exception f) { MessageBox.Show(f.Message, "LMIS", MessageBoxButtons.OK, MessageBoxIcon.Error); }


                //generate text file & navigate file
                string reportPath = Application.StartupPath + "/lmis_report" + DateTime.Now.Date.ToShortDateString().Replace("/", "_") + ".txt";

                FileStream fs = new FileStream(reportPath, FileMode.Create, FileAccess.Write);
                StreamWriter sw = new StreamWriter(fs);

                sw.WriteLine(HEADER);
                sw.WriteLine(TITLE);
                sw.WriteLine(info);
                sw.WriteLine("TOTAL NUMBER OF BOOKS : " + noOfBooks.ToString());
                sw.WriteLine("TOTAL NUMBER OF SERIALS : " + noOfSerials.ToString());
                sw.WriteLine("TOTAL NUMBER OF REGISTERED STUDENTS : " + noOfStudents.ToString());
                sw.WriteLine("TOTAL NUMBER OF REGISTERED STAFF : " + noOfStaff.ToString());
                sw.WriteLine("TOTAL NUMBER OF LOANED ITEMS FROM " + startDate + " TO " + endDate + " : " + noOfLoaned.ToString());
                sw.WriteLine("TOTAL NUMBER OF RETURNED ITEMS FROM " + startDate + " TO " + endDate + " : " + noOfReturned.ToString());
                sw.WriteLine("TOTAL NUMBER OF OVERDUE ITEMS : " + noOfOverdue.ToString());
                sw.WriteLine("TOTAL NUMBER OF AVAILABLE SUBJECTS : " + noOfSubjects.ToString());

                sw.Close();
                fs.Close();

                Uri u = new Uri(reportPath);
                browser.Url = u;
            }
            catch (Exception f) { MessageBox.Show(f.Message, "LMIS", MessageBoxButtons.OK, MessageBoxIcon.Error); }            
        }
    }
}
